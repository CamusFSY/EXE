name: Build Windows EXE

on:
  workflow_dispatch:
  push:
    paths:
      - "send_hospital_reports_v9.py"
      - ".github/workflows/build-exe.yml"
      - "requirements.txt"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          # 你的脚本若还有其它依赖可写进 requirements.txt（可选）
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller pywin32

      - name: Verify pywin32
        shell: bash
        run: |
          python - << 'PY'
          import pythoncom, win32com.client, pywintypes
          print("pywin32 OK")
          PY

      - name: Build EXE with PyInstaller
        shell: bash
        run: |
          pyinstaller --noconfirm --onefile --windowed \
            --name SendHospitalReports \
            --hidden-import=win32com --hidden-import=win32com.client \
            --hidden-import=pythoncom --hidden-import=pywintypes \
            --collect-submodules win32com --collect-data win32com \
            send_hospital_reports_v9.py

      - name: Copy extras (optional)
        shell: bash
        run: |
          mkdir -p dist
          # 若仓库里有示例配置/说明就一起打包到发布产物里（可选）
          [ -f README.txt ] && cp README.txt dist/README.txt || true
          [ -f mail_config.csv ] && cp mail_config.csv dist/mail_config.csv || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SendHospitalReports_windows
          path: |
            dist/SendHospitalReports.exe
            dist/README.txt
            dist/mail_config.csv

  release:
    # 只有打 tag（例如 refs/tags/v1.0.0）时才会跑
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: SendHospitalReports_windows
          path: release_dist

      - name: Zip
        run: |
          powershell -Command "Compress-Archive -Path release_dist\* -DestinationPath SendHospitalReports_win.zip"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: SendHospitalReports_win.zip
